'use client';

import { useState } from 'react';
import { useAuth } from '@/hooks/use-auth';
import { db } from '@/lib/firebase';
import { collection, query, where, orderBy, addDoc, serverTimestamp, doc, setDoc, getDocs, updateDoc } from 'firebase/firestore';
import { useCollection } from 'react-firebase-hooks/firestore';
import { DocuPilotDocument, ChatMessage as ChatMessageType, ChatSession } from '@/lib/types';
import { DocumentSelector } from './_components/document-selector';
import { ChatInput } from './_components/chat-input';
import { ChatMessageList } from './_components/chat-message-list';
import { Alert, AlertDescription, AlertTitle } from '@/components/ui/alert';
import { MessageSquare, FileWarning, PlusCircle } from 'lucide-react';
import { chatWithDocument } from '@/ai/flows/chat-with-document';
import { useToast } from '@/hooks/use-toast';
import { v4 as uuidv4 } from 'uuid';
import { SessionList } from './_components/session-list';
import { Button } from '@/components/ui/button';

enum ChatView {
  SESSION_LIST,
  DOCUMENT_SELECTOR,
  CHAT_VIEW,
}

export default function ChatPage() {
  const { user } = useAuth();
  const { toast } = useToast();
  
  const [view, setView] = useState<ChatView>(ChatView.SESSION_LIST);
  const [selectedDoc, setSelectedDoc] = useState<DocuPilotDocument | null>(null);
  const [activeSessionId, setActiveSessionId] = useState<string | null>(null);
  const [isResponding, setIsResponding] = useState(false);

  // Fetch documents for the selector
  const [docsSnapshot, docsLoading, docsError] = useCollection(
    user ? query(collection(db, 'users', user.uid, 'documents'), orderBy('createdAt', 'desc')) : null
  );
  const documents = docsSnapshot?.docs.map(d => ({ id: d.id, ...d.data() } as DocuPilotDocument)) || [];

  // Fetch chat sessions
  const [sessionsSnapshot, sessionsLoading, sessionsError] = useCollection(
    user ? query(collection(db, 'users', user.uid, 'conversations'), orderBy('updatedAt', 'desc')) : null
  );
  const sessions = sessionsSnapshot?.docs.map(d => ({ id: d.id, ...d.data() } as ChatSession)) || [];


  // Fetch messages for the active session
  const [messagesSnapshot, messagesLoading, messagesError] = useCollection(
    (user && activeSessionId) ? query(collection(db, `users/${user.uid}/conversations/${activeSessionId}/messages`), orderBy('createdAt', 'asc')) : null
  );
  const messages = messagesSnapshot?.docs.map(d => ({ id: d.id, ...d.data() } as ChatMessageType)) || [];
  
  const handleSelectSession = (session: ChatSession) => {
    const doc = documents.find(d => d.id === session.documentId);
    if (doc) {
      setSelectedDoc(doc);
      setActiveSessionId(session.id);
      setView(ChatView.CHAT_VIEW);
    } else {
      toast({
        variant: 'destructive',
        title: 'Document not found',
        description: 'The document associated with this chat may have been deleted.',
      });
    }
  };

  const handleSelectDocument = (doc: DocuPilotDocument) => {
    setSelectedDoc(doc);
    // Don't set session ID yet, will be created on first message
    setActiveSessionId(null); 
    setView(ChatView.CHAT_VIEW);
  };


  const handleSendMessage = async (content: string) => {
    if (!user || !selectedDoc) return;
    setIsResponding(true);

    let currentSessionId = activeSessionId;
    
    // Create a new session if one doesn't exist
    if (!currentSessionId) {
      const newSessionId = uuidv4();
      const sessionRef = doc(db, 'users', user.uid, 'conversations', newSessionId);
      await setDoc(sessionRef, {
        id: newSessionId,
        userId: user.uid,
        documentId: selectedDoc.id,
        documentName: selectedDoc.name,
        createdAt: serverTimestamp(),
        updatedAt: serverTimestamp(),
        firstMessage: content,
      });
      setActiveSessionId(newSessionId);
      currentSessionId = newSessionId;
    } else {
        // Update the 'updatedAt' timestamp on the existing session
        const sessionRef = doc(db, 'users', user.uid, 'conversations', currentSessionId);
        await updateDoc(sessionRef, { updatedAt: serverTimestamp() });
    }

    if (!currentSessionId) {
        toast({
            variant: 'destructive',
            title: 'Error',
            description: 'Could not create or find a chat session.',
        });
        setIsResponding(false);
        return;
    }

    const messagesCollection = collection(db, `users/${user.uid}/conversations/${currentSessionId}/messages`);

    // Add user message to Firestore
    const userMessage: Omit<ChatMessageType, 'id' | 'createdAt'> = {
      role: 'user',
      content,
      conversationId: currentSessionId,
    };
    await addDoc(messagesCollection, { ...userMessage, createdAt: serverTimestamp() });

    try {
      // Call the AI flow
      const result = await chatWithDocument({
        question: content,
        documentText: selectedDoc.content,
      });

      // Add agent response to Firestore
      const agentMessage: Omit<ChatMessageType, 'id' | 'createdAt'> = {
        role: 'assistant',
        content: result.answer,
        citations: result.citations.map(c => ({ name: selectedDoc.name, id: selectedDoc.id, text: c.text, startIndex: c.startIndex, endIndex: c.endIndex })),
        conversationId: currentSessionId,
      };
      await addDoc(messagesCollection, { ...agentMessage, createdAt: serverTimestamp() });

    } catch (error) {
      console.error('Error chatting with document:', error);
      toast({
        variant: 'destructive',
        title: 'Error',
        description: 'Could not get a response from the document.',
      });
       const agentMessage: Omit<ChatMessageType, 'id' | 'createdAt'> = {
        role: 'assistant',
        content: "Sorry, I ran into an error trying to answer that.",
        conversationId: currentSessionId,
      };
      await addDoc(messagesCollection, { ...agentMessage, createdAt: serverTimestamp() });
    } finally {
      setIsResponding(false);
    }
  };
  
  const startNewChat = () => {
      setView(ChatView.DOCUMENT_SELECTOR);
      setSelectedDoc(null);
      setActiveSessionId(null);
  }
  
  const showSessionList = () => {
    setView(ChatView.SESSION_LIST);
    setSelectedDoc(null);
    setActiveSessionId(null);
  }

  const renderContent = () => {
    switch (view) {
      case ChatView.SESSION_LIST:
        return (
          <SessionList
            sessions={sessions}
            isLoading={sessionsLoading}
            error={sessionsError}
            onSelectSession={handleSelectSession}
          />
        );
      case ChatView.DOCUMENT_SELECTOR:
        return (
          <DocumentSelector
            documents={documents}
            isLoading={docsLoading}
            onSelect={handleSelectDocument}
            error={docsError}
          />
        );
      case ChatView.CHAT_VIEW:
        if (!selectedDoc) return null;
        return (
            <div className="flex-1 flex flex-col min-h-0">
              <div className="p-3 rounded-lg border bg-muted mb-4">
                  <p className="text-sm text-muted-foreground">
                      You are chatting with: <span className="font-semibold text-foreground">{selectedDoc.name}</span>
                  </p>
              </div>
              <div className="flex-1 overflow-y-auto">
                {messagesError && (
                     <Alert variant="destructive">
                        <FileWarning className="h-4 w-4" />
                        <AlertTitle>Error loading messages</AlertTitle>
                        <AlertDescription>Could not load the conversation. Please try again.</AlertDescription>
                    </Alert>
                )}
                {!messagesError && <ChatMessageList messages={messages} isLoading={messagesLoading && messages.length === 0} />}
              </div>
              <div className="mt-4">
                <ChatInput onSendMessage={handleSendMessage} isLoading={isResponding} />
              </div>
            </div>
          );
      default:
        return null;
    }
  }

  return (
    <div className="flex h-[calc(100vh-4rem)] md:h-[calc(100vh-5rem)] flex-col">
      <div className="flex justify-between items-center mb-4">
         <div>
            <h1 className="text-3xl font-bold">Chat</h1>
            <p className="text-muted-foreground">
                {view === ChatView.CHAT_VIEW ? "Ask questions and get insights from your documents." : "Select a past conversation or start a new one."}
            </p>
        </div>
        <div>
          {view === ChatView.CHAT_VIEW && (
              <Button variant="ghost" onClick={showSessionList} className="text-sm text-primary hover:underline">
                  All Chats
              </Button>
          )}
          {view === ChatView.SESSION_LIST && (
              <Button onClick={startNewChat}>
                  <PlusCircle className="mr-2 h-4 w-4"/>
                  New Chat
              </Button>
          )}
           {view === ChatView.DOCUMENT_SELECTOR && (
              <Button variant="ghost" onClick={showSessionList} className="text-sm text-primary hover:underline">
                  Back to All Chats
              </Button>
          )}
        </div>
      </div>

      {renderContent()}

    </div>
  );
}
